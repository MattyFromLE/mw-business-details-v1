<?php       /*     Plugin Name: Business Details    Plugin URI: https://www.creare.co.uk/    Description: A simple plugin for adding business details.    Author: Matt Williamson    Version: 1.0.0    Author URI: http://www.creare.co.uk/    */   	/*  Copyright 2013  WILLIAMSON, CREAREGROUP  (email : matt.w@creare.co.uk)    This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License, version 2, as     published by the Free Software Foundation.    This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.    You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA		*/$mw_business_details = new mw_business_details();/*---------------------------------------------------------------------------1 - Class---------------------------------------------------------------------------*/class mw_business_details {    public function __construct() {        // admin stuff        if ( is_admin() ){             add_action('admin_menu', array(&$this, 'mw_admin_actions'));               add_action('admin_init', array(&$this, 'mw_admin_init'));        }        // init stuff        add_action( 'init', array(&$this, 'mw_init' ));        // admin theme        add_action( 'admin_init', array(&$this, 'mw_custom_admin_themes' ) );        // login logo        add_action( 'login_enqueue_scripts', array(&$this, 'show_login_logo') );        // settings page link        add_filter( 'plugin_action_links', array(&$this, 'settings_link'), 10, 2);                // add social ajax hooks        add_action( 'wp_ajax_social_ajax', array(&$this, 'social_ajax') );        add_action( 'wp_ajax_nopriv_social_ajax', array(&$this, 'social_ajax') );        // delete social option        add_action( 'wp_ajax_social_ajax_delete', array(&$this, 'social_ajax_delete') );        add_action( 'wp_ajax_nopriv_social_ajax_delete', array(&$this, 'social_ajax_delete') );        // add address hooks        add_action( 'wp_ajax_new_business_address', array(&$this, 'new_business_address') );        add_action( 'wp_ajax_nopriv_new_business_address', array(&$this, 'new_business_address') );        // delete address        add_action( 'wp_ajax_delete_business_address', array(&$this, 'delete_business_address') );        add_action( 'wp_ajax_nopriv_delete_business_address', array(&$this, 'delete_business_address') );    }	    // seperate pages and set capabilities    public function mw_admin_actions() {         // admin page        $page_title = "Business Details";        $menu_title = "Business Details";        $capability = "edit_posts";         $menu_slug = "mw-business-details";        $page = add_menu_page( $page_title, $menu_title, $capability, $menu_slug, array(&$this, "mw_admin") );        // main settings page        add_submenu_page( $menu_slug, $page_title, "Address Details", $capability, $menu_slug, array(&$this, "mw_admin") );        // company information page        add_submenu_page( $menu_slug, "Company Details", "Company Details", $capability, "mwbd-company-details", array(&$this, "mw_company_details") );               // map settings page        add_submenu_page( $menu_slug, "Map Settings", "Map Settings", $capability, "mwbd-map-settings", array(&$this, "mw_map_settings") );        // social settings page        add_submenu_page( $menu_slug, "Social Settings", "Social Settings", $capability, "mwbd-social-settings", array(&$this, "mw_social_settings") );        // opening times page        add_submenu_page( $menu_slug, "Opening Times", "Opening Times", $capability, "mwbd-opening-times", array(&$this, "mw_opening_times") );        // sub page for help        add_submenu_page( $menu_slug, "Help", "Help", $capability, "mwbd-help", array(&$this, "mw_help") );    }    public function mw_admin_init() {        $this->mw_business_details_admin_assets();        $this->showAdminMessages();        $this->mw_theme_options_init();    }        public function mw_admin() {          include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-settings.php' );              }    public function mw_company_details() {          include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-company-details.php' );              }    public function mw_map_settings() {          include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-map-settings.php' );              }    public function mw_social_settings() {          include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-social-settings.php' );              }    public function mw_opening_times() {          include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-opening-times.php' );              }    public function mw_help() {          include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-help.php' );              }    public function showAdminMessages() {              $plugin_messages = array();    include_once( ABSPATH . 'wp-admin/includes/plugin.php' );    // Download the Yoast WordPress SEO plugin    if( is_plugin_active( 'wordpress-seo/wp-seo.php' ) ) {            if(count($plugin_messages) > 0) {                echo '<div id="message" class="error">';                  foreach($plugin_messages as $message) {                    echo '<p><strong>'.$message.'</strong></p>';                  }                echo '</div>';                        }        }    }    function mw_init() {        $imgWidth = get_option('imgWidth');        $imgHeight = get_option('imgHeight');        add_image_size( 'mw-logo-size', $imgWidth, $imgHeight, true );        add_image_size( 'mw-login-logo', 320, 999, true );        include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-shortcodes.php' );        $mw_business_details_shortcodes = new mw_business_details_shortcodes();    }	    function mw_business_details_admin_assets() {        if ( isset($_GET['page']) ) {                $mwbdPage = $_GET['page'];                $mwbdPagePrefix = substr( $mwbdPage, 0, 4 );            if ( isset($_GET['page']) && $_GET['page'] == 'mw-business-details' || $mwbdPagePrefix === "mwbd" ) {                               wp_enqueue_media();                // admim styles                wp_register_style( 'mwbusinessadminstyles', plugins_url('/css/mw-business-details.css', __FILE__ ),'','', 'screen' );                wp_enqueue_style( 'mwbusinessadminstyles' );                // admin scripts                wp_register_script('mw-theme-scripts-admin', plugins_url( '/js/min/theme-min.js', __FILE__ ), array('jquery'), null );                wp_enqueue_script('mw-theme-scripts-admin');                // social ajax                wp_register_script('social_ajax_assets_admin', plugins_url( '/js/social-ajax.js', __FILE__ ), array('jquery'), null );                wp_localize_script( 'social_ajax_assets_admin', 'social_ajax_params', array( 'ajax_url' => admin_url( 'admin-ajax.php' ) ) );                wp_enqueue_script('social_ajax_assets_admin');                // social ajax                wp_register_script('address_ajax_assets_admin', plugins_url( '/js/address-ajax.js', __FILE__ ), array('jquery'), null );                wp_localize_script( 'address_ajax_assets_admin', 'address_ajax_params', array( 'ajax_url' => admin_url( 'admin-ajax.php' ) ) );                wp_enqueue_script('address_ajax_assets_admin');            }        }    }    public function show_login_logo() {        // is login logo checked        $loginLogo = get_option('show_login_logo');        // load in logo src        $logoID = get_option('business_logo_id');                $logoSrc = wp_get_attachment_image_src( $logoID, 'mw-login-logo' );        // check for better versions        $logoUrljpg = str_replace( '.svg', '.jpg', $logoSrc[0] );        $logoUrlpng = str_replace( '.svg', '.png', $logoSrc[0] );        if ( @GetImageSize( $logoUrljpg ) ) {            $logoSrc = $logoUrljpg;        } else if ( @GetImageSize( $logoUrlpng ) ) {            $logoSrc = $logoUrlpng;        } else {            $logoSrc = $logoSrc[0];        }        if ( $loginLogo == true ){    ?>                <style type="text/css">            body.login div#login h1 a {                background-image: <?php echo 'url("'.$logoSrc.'")'; ?>;                background-position: center;                padding: 0;                width: 100%;                background-size: 250px;            }        </style>    <?php }            }    // custom styles    public function mw_custom_admin_themes() {        wp_admin_css_color(            'business-details',             __( 'Business Details' ),             plugins_url('/css/admin-themes/bd/color-scheme.css', __FILE__ ),             array( '#313131', '#70bf44' )        );    }        // settings page link    function settings_link($links, $file) {        $plugin_file = basename(__FILE__);        if (basename($file) == $plugin_file) {            $settings_link = '<a href="options-general.php?page=MW Business Details">Settings</a>';            array_unshift($links, $settings_link);        }        return $links;    }        // mwbd options    public function mw_theme_options_init(){        // address                register_setting( 'mwbd-address-details', 'street_address' );        register_setting( 'mwbd-address-details', 'address_locality' );        register_setting( 'mwbd-address-details', 'address_region' );        register_setting( 'mwbd-address-details', 'post_code' );        // new address system        register_setting( 'mwbd-address-details', 'businessType' );        register_setting( 'mwbd-address-details', 'main_address' );        register_setting( 'mwbd-address-details', 'business_address' );        // logo        register_setting( 'mwbd_company_details', 'business_logo' );        register_setting( 'mwbd_company_details', 'business_logo_id' );        register_setting( 'mwbd_company_details', 'show_login_logo' );        register_setting( 'mwbd_company_details', 'imgWidth' );        register_setting( 'mwbd_company_details', 'imgHeight' );        // contact details                register_setting( 'mwbd_company_details', 'company_name' );        register_setting( 'mwbd_company_details', 'autoTracking' );        register_setting( 'mwbd_company_details', 'showTrackingAlert' );        register_setting( 'mwbd_company_details', 'tel_no' );        register_setting( 'mwbd_company_details', 'fax_no' );        register_setting( 'mwbd_company_details', 'alt_no' );        register_setting( 'mwbd_company_details', 'company_no' );        register_setting( 'mwbd_company_details', 'e-mail_address' );        register_setting( 'mwbd_company_details', 'mw-contact-text' );        // google maps                register_setting( 'mwbd_map_settings', 'mapShowPage' );        register_setting( 'mwbd_map_settings', 'addressChoice' );        register_setting( 'mwbd_map_settings', 'lat' );        register_setting( 'mwbd_map_settings', 'long' );        register_setting( 'mwbd_map_settings', 'mapShow' );        register_setting( 'mwbd_map_settings', 'zoom' );        register_setting( 'mwbd_map_settings', 'mapMarker' );        register_setting( 'mwbd_map_settings', 'pin' );        register_setting( 'mwbd_map_settings', 'pinImage' );        register_setting( 'mwbd_map_settings', 'markerWidth' );        register_setting( 'mwbd_map_settings', 'markerHeight' );        register_setting( 'mwbd_map_settings', 'radiusDistance' );        register_setting( 'mwbd_map_settings', 'showInfoWindow' );        register_setting( 'mwbd_map_settings', 'mapStyle' );        register_setting( 'mwbd_map_settings', 'customMap' );        register_setting( 'mwbd_map_settings', 'googleMapsLink' );        // social                register_setting( 'mwbd_social_settings', 'mwSocialStyles' );        register_setting( 'mwbd_social_settings', 'twitter' );        register_setting( 'mwbd_social_settings', 'facebook' );        register_setting( 'mwbd_social_settings', 'linkedIn' );        register_setting( 'mwbd_social_settings', 'googlePlus' );        register_setting( 'mwbd_social_settings', 'newSocialNetwork' );        // Opening Times                register_setting( 'mwbd_opening_times', 'openingTimeFormat' );        register_setting( 'mwbd_opening_times', 'twentyFourSeven' );        register_setting( 'mwbd_opening_times', 'monFriTimes' );        register_setting( 'mwbd_opening_times', 'monday' );        register_setting( 'mwbd_opening_times', 'tuesday' );        register_setting( 'mwbd_opening_times', 'wednesday' );        register_setting( 'mwbd_opening_times', 'thursday' );        register_setting( 'mwbd_opening_times', 'friday' );        register_setting( 'mwbd_opening_times', 'saturday' );        register_setting( 'mwbd_opening_times', 'sunday' );    }     // mark up for ajax loaded new social methods    public function social_ajax() {        $socialOptionName = $_GET['id'];        $socialOptionName = strtolower($socialOptionName);        $socialOptionName = str_replace( ' ', '-', $socialOptionName);        $mwbdHtml = '';        $mwbdHtml .= '        <tr class="addNew">                    <th scope="row"><span>'. $socialOptionName = $_GET['id'] .' Details</th>                        <td>                  <input class="regular-text" type="text" name="newSocialNetwork['. $socialOptionName .'][url]" value="" placeholder="Enter URL" />                  <p class="description">Enter a URL for '.$socialOptionName.'</p>            </td>        </tr>';        echo $mwbdHtml;        die();    }    // delete social method    public function social_ajax_delete() {        $deleteSocialOption = $_GET['id'];        $deleteOption = get_option('newSocialNetwork');                unset( $deleteOption[ $deleteSocialOption ] );        update_option( 'newSocialNetwork', $deleteOption );        die();    }    // markup for new address template    public function new_business_address() {        $newBusinessAddressName = $_GET['addressName'];        $newBusinessAddressName = str_replace( ' ', '-', $newBusinessAddressName );        $newBusinessAddressName = strtolower( $newBusinessAddressName );        include( plugin_dir_path( __FILE__ ) . '/includes/mwbd-address-template.php' );        die();    }    // ajax delete address    public function delete_business_address() {        $deleteBusinessAddress = $_GET['id'];        $deleteOption = get_option('business_address');                unset( $deleteOption[ $deleteBusinessAddress ] );        update_option( 'business_address', $deleteOption );        die();    }} 